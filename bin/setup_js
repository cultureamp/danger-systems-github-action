#!/bin/bash
set -euo pipefail

js_build () {
  DANGER_SYSTEMS_LANGUAGE_VERSION=${DANGER_SYSTEMS_LANGUAGE_VERSION:-"12"}

  BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

  echo "Event path: $GITHUB_EVENT_PATH"
  cat "$GITHUB_EVENT_PATH"

  echo "--- :docker: Building danger-js image"
  docker build \
    -t cultureamp/danger-js \
    --build-arg NODE_IMAGE_VERSION="${DANGER_SYSTEMS_LANGUAGE_VERSION}" \
    -f "$BASEDIR/Dockerfile.node" "$GITHUB_WORKSPACE"
}

js_run () {
  # Installation vars
  GH_NPM_REGISTRY_TOKEN=${GH_NPM_REGISTRY_TOKEN:-}
  # Run vars
  GITHUB_TOKEN=${GITHUB_TOKEN:-}
  GITHUB_WORKFLOW=${GITHUB_WORKFLOW:-}
  CI=${CI:-}
  GITHUB_ACTION=${GITHUB_ACTION:-}
  GITHUB_ACTIONS=${GITHUB_ACTIONS:-}
  GITHUB_ACTOR=${GITHUB_ACTOR:-}
  GITHUB_API_URL=${GITHUB_API_URL:-}
  GITHUB_BASE_REF=${GITHUB_BASE_REF:-}
  GITHUB_EVENT_NAME=${GITHUB_EVENT_NAME:-}
  GITHUB_GRAPHQL_URL=${GITHUB_GRAPHQL_URL:-}
  GITHUB_HEAD_REF=${GITHUB_HEAD_REF:-}
  GITHUB_REF=${GITHUB_REF:-}
  GITHUB_REPOSITORY=${GITHUB_REPOSITORY:-}
  GITHUB_RUN_ID=${GITHUB_RUN_ID:-}
  GITHUB_RUN_NUMBER=${GITHUB_RUN_NUMBER:-}
  GITHUB_SERVER_URL=${GITHUB_SERVER_URL:-}
  GITHUB_SHA=${GITHUB_SHA:-}
  GITHUB_WORKSPACE=${GITHUB_WORKSPACE:-}

  BASEDIR="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && cd .. && pwd )"

  echo "--- :docker: Running danger-js"
  docker run \
    -v "$GITHUB_WORKSPACE":/home/app \
    -v "$BASEDIR/bin":/home/build \
    -v "$GITHUB_EVENT_PATH":/home/event.json \
    -e GH_NPM_REGISTRY_TOKEN="$GH_NPM_REGISTRY_TOKEN" \
    -e GITHUB_TOKEN="$GITHUB_TOKEN" \
    -e GITHUB_WORKFLOW="$GITHUB_WORKFLOW" \
    -e GITHUB_EVENT_PATH=/home/event.json \
    -e CI="$CI" \
    -e GITHUB_ACTION="$GITHUB_ACTION" \
    -e GITHUB_ACTIONS="$GITHUB_ACTIONS" \
    -e GITHUB_ACTOR="$GITHUB_ACTOR" \
    -e GITHUB_API_URL="$GITHUB_API_URL" \
    -e GITHUB_BASE_REF="$GITHUB_BASE_REF" \
    -e GITHUB_EVENT_NAME="$GITHUB_EVENT_NAME" \
    -e GITHUB_GRAPHQL_URL="$GITHUB_GRAPHQL_URL" \
    -e GITHUB_HEAD_REF="$GITHUB_HEAD_REF" \
    -e GITHUB_REF="$GITHUB_REF" \
    -e GITHUB_REPOSITORY="$GITHUB_REPOSITORY" \
    -e GITHUB_RUN_ID="$GITHUB_RUN_ID" \
    -e GITHUB_RUN_NUMBER="$GITHUB_RUN_NUMBER" \
    -e GITHUB_SERVER_URL="$GITHUB_SERVER_URL" \
    -e GITHUB_SHA="$GITHUB_SHA" \
    -e GITHUB_WORKSPACE="$GITHUB_WORKSPACE" \
    cultureamp/danger-js \
    /bin/sh /home/build/docker_js_run
}
